<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ETCD Keeper</title>
    <link rel="stylesheet" type="text/css" href="../framework/easyui/themes/metro/easyui.css">
    <link rel="stylesheet" type="text/css" href="../framework/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../framework/custom/css/style.css">
    <!-- 此行代码解决ie8中iframe里嵌套此页面会导致jquery错误-->
    <script>document.documentElement.focus();</script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script type="text/javascript" src="../framework/easyui/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../framework/ace/ace.js" charset="utf-8"></script>
    <style>
        #value {
            position: absolute;
            top: 40px;
            right: 15px;
            bottom: 40px;
            left: 15px;
            border: 1px solid #ddd;
            font-size: 13px !important;
        }
    </style>
</head>
<body style="overflow: hidden;">
<div style="margin:20px 0;"></div>
<div id="elayout" class="easyui-layout" style="width:100%;height:550px;">
    <div id="p" data-options="region:'west',tools:'#westTools'" title="Nodes" style="width:30%;padding:10px">
        <ul id="etree" class="easyui-tree"></ul>
    </div>
    <div data-options="region:'center',tools:'#centerTools',footer:'#footer'" title="/" spellcheck="false"
         style="padding:10px;overflow:hidden;">
        <div id="value"></div>
    </div>
</div>

<div id="footer" style="padding:5px;color:#777;">&nbsp;</div>

<div style="text-align:right;color:#BDBDBD;margin-top:2px;">
    <span id="statusVersion"></span>
    <span id="statusSize" style="margin-left: 10px;"></span>
    <span id="statusMember" style="margin-left: 10px;"></span>
    <span style="margin-left: 10px;">ETCD Keeper 0.7.6</span>
</div>
<script>
    resizeWindow();
    $(window).resize(function () { // FIXME: invalid
        resizeWindow();
    });

    function resizeWindow() {
        $('#elayout').height(($(window).height() - 128) + 'px')
    }

    let timeout = 5000 // milliseconds
    let separator = '/';
    let tree = [];
    let idCount = 0;
    let editor = ace.edit('value');
    editor.$blockScrolling = Infinity;
    aceMode = 'text';
    treeMode = 'path';


    $(document).ready(function () {
        init();
        $('#versionMenu').menu('setIcon', {
            target: $('#version_3')[0],
            iconCls: 'icon-ok'
        });
    });

    function init() {
        $('#etree').tree({
            animate: true,
            onClick: showNode,
            onContextMenu: showMenu
        });
        connect();
    }


    function connect() {
        $.ajax({
            type: 'POST',
            timeout: timeout,
            url: '/v3/connect',
            async: false,
            dataType: 'json',
            success: function (data) {
                $('#statusVersion').html('ETCD version:' + data.info.version);
                $('#statusSize').html('Size:' + data.info.size)
                $('#statusMember').html('Member name:' + data.info.name)
            },
            error: function (err) {
                $.messager.alert('Error', $.toJSON(err), 'error');
            }
        });
        reload();
    }

    function reload() {
        const rootNode = {
            id: getId(),
            children: [],
            dir: true,
            path: separator,
            text: separator,
            iconCls: 'icon-dir'
        };
        tree = [];
        tree.push(rootNode);
        $('#etree').tree('loadData', tree);
        showNode($('#etree').tree('getRoot'));
        resetValue();
    }

    function resetValue() {
        $('#elayout').layout('panel', 'center').panel('setTitle', separator);
        editor.getSession().setValue('');
        editor.setReadOnly(false);
        $('#footer').html('&nbsp;');
    }

    function showNode(node) {
        $('#elayout').layout('panel', 'center').panel('setTitle', node.path);
        editor.getSession().setValue('');
        if (node.dir === false) {
            editor.setReadOnly(false);
            $.ajax({
                type: 'GET',
                timeout: timeout,
                url: '/v3/get',
                data: {'key': node.path},
                async: true,
                dataType: 'json',
                success: function (data) {
                    if (data.errorCode) {
                        $('#etree').tree('remove', node.target);
                        console.log(data.message);
                        resetValue()
                    } else {
                        editor.getSession().setValue(data.node.value);
                        var ttl = 0;
                        if (data.node.ttl) {
                            ttl = data.node.ttl;
                        }
                        changeFooter(ttl, data.node.createdIndex, data.node.modifiedIndex);
                    }
                },
                error: function (err) {
                    $.messager.alert('Error', $.toJSON(err), 'error');
                }
            });
        } else {
            if (node.children.length > 0) {
                $('#etree').tree(node.state === 'closed' ? 'expand' : 'collapse', node.target);
            }
            $('#footer').html('&nbsp;');
            // clear child node
            var children = $('#etree').tree('getChildren', node.target);
            var url = '';
            url = '/v3/getpath';
            $.ajax({
                type: 'GET',
                timeout: timeout,
                url: url,
                data: {'key': node.path, 'prefix': 'true'},
                async: true,
                dataType: 'json',
                success: function (data) {
                    if (data.node.value) {
                        editor.getSession().setValue(data.node.value);
                        changeFooter(data.node.ttl, data.node.createdIndex, data.node.modifiedIndex);
                    }
                    let arr = [];

                    if (data.node.nodes) {
                        // refresh child node
                        for (var i in data.node.nodes) {
                            var newData = getNode(data.node.nodes[i]);
                            arr.push(newData);
                        }
                        $('#etree').tree('append', {
                            parent: node.target,
                            data: arr
                        });
                    }

                    for (var n in children) {
                        $('#etree').tree('remove', children[n].target);
                    }

                },
                error: function (err) {
                    $.messager.alert('Error', $.toJSON(err), 'error');
                }
            });
        }
    }

    function getNode(n) {
        var path = n.key.split(separator);
        let text = path[path.length - 1];
        const obj = {
            id: getId(),
            text: text,
            dir: false,
            iconCls: 'icon-text',
            path: n.key,
            children: []
        };
        if (n.dir === true) {
            obj.state = 'closed';
            obj.dir = true;
            obj.iconCls = 'icon-dir';
            if (n.nodes) {
                for (var i in n.nodes) {
                    var rn = getNode(n.nodes[i]);
                    obj.children.push(rn);
                }
            }
        }
        return obj
    }

    function showMenu(e, node) {
        e.preventDefault();
        $('#etree').tree('select', node.target);
        $('#treeDirMenu').menu('show', {
            left: e.pageX,
            top: e.pageY
        });
    }


    function selDir(item) {
        if (item.value === 'true') {
            $('#cvalue').textbox('disable', 'none');
        } else {
            $('#cvalue').textbox('enable', 'none');
        }
    }


    function getId() {
        return idCount++;
    }


    function changeFooter(ttl, cIndex, mIndex) {
        $('#footer').html('<span>TTL&nbsp;:&nbsp;' + ttl + '&nbsp;&nbsp;&nbsp;&nbsp;CreateRevision&nbsp;:&nbsp;' + cIndex + '&nbsp;&nbsp;&nbsp;&nbsp;ModRevision&nbsp;:&nbsp;' + mIndex + '</span><span id="showMode" style="position: absolute;right: 10px;color: #777;">' + aceMode + '</span>');
    }

</script>
</body>
</html>